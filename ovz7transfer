#!/bin/bash

# Function to check and install a package if it's not available
install_package() {
    if ! command -v $1 &> /dev/null; then
        if command -v apt-get &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y $1
        elif command -v yum &> /dev/null; then
            sudo yum install -y $1
        else
            echo "Please install $1 manually, or use an appropriate package manager for your system."
            exit 1
        fi
    fi
}

# Check and install essential packages
install_package wget

# Generate an SSH key pair if one doesn't exist
if [ ! -f ~/.ssh/id_rsa ]; then
    ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
fi

# Prompt the user to enter the remote IP and port
read -p "Enter the remote IP: " REMOTE_IP
read -p "Enter the SSH port (default is 22): " SSH_PORT
SSH_PORT=${SSH_PORT:-22}  # Use port 22 by default if no port is specified

# Prompt the user for the password to use for SCP
read -s -p "Enter your password for SCP: " SCP_PASSWORD
echo

# Copy the SSH public key to the remote host using SCP
scp -P $SSH_PORT ~/.ssh/id_rsa.pub root@$REMOTE_IP:~/.ssh/authorized_keys

# Check if the key copy was successful
if [ $? -eq 0 ]; then
    echo "SSH key added successfully to the remote host."
else
    echo "Failed to add the SSH key. Please check your password and try again."
    exit 1
fi

# Download the ovztransfer.sh script and save it as ovztransfer.sh
install_package wget  # Make sure wget is installed
wget -O ovztransfer.sh "https://src.openvz.org/projects/OVZL/repos/ovztransfer/raw/ovztransfer.sh?at=refs%2Fheads%2Fmaster"

# Assign execute permissions to the script
chmod +x ovztransfer.sh

# Check if screen is installed, and install if not
install_package screen

# List VMs and exclude the header line
CTID_LIST=$(vzlist -a | awk '{print $1}' | grep -v CTID)

# Start a screen session
screen -dmS vm_management

# Run the VM management script inside the screen session
screen -S vm_management -X stuff "
for CTID in $CTID_LIST; do
    echo 'Managing VM $CTID'
    
    vzctl stop $CTID >> ovztransfer.log 2>&1
    
    CONFIG_FILE=\"/etc/sysconfig/vz-scripts/$CTID.conf\"
    if [ -f \$CONFIG_FILE ]; then
        if grep -q 'DISABLED=\"yes\"' \$CONFIG_FILE; then
            sed -i 's/DISABLED=\"yes\"/DISABLED=\"no\"/' \$CONFIG_FILE
            echo 'VM $CTID has been enabled.' >> ovztransfer.log 2>&1
        else
            echo 'VM $CTID is already enabled.' >> ovztransfer.log 2>&1
        fi
    else
        echo 'Configuration file \$CONFIG_FILE not found.' >> ovztransfer.log 2>&1
    fi

    ./ovztransfer.sh \$REMOTE_IP \$CTID:\$CTID >> ovztransfer.log 2>&1

    if [ \$? -eq 0 ]; then
        echo 'Transfer for VM $CTID was successful.'
    else
        echo 'Transfer for VM $CTID failed. Skipping VM.' >> ovztransfer.log 2>&1
        continue
    fi

    vzctl start $CTID >> ovztransfer.log 2>&1

    echo 'VM $CTID management completed.' >> ovztransfer.log
done
"

echo "VM management script is running in a detached screen session."
